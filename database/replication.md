
Репликация баз данных — это процесс копирования и поддержания копий данных базы данных на нескольких серверах.
Основная цель репликации — повысить доступность, производительность и надежность системы,
а также обеспечить отказоустойчивость и балансировку нагрузки.


Виды репликации

    Синхронная репликация:
        Данные записываются одновременно на основной и реплицированные серверы. Это гарантирует, что все копии
        базы данных содержат одинаковую информацию в любое время.

        Преимущество: Высокая консистентность данных.

        Недостаток: Увеличение времени записи данных, так как запись должна быть подтверждена всеми репликами.


    Асинхронная репликация:
        Данные сначала записываются на основной сервер, а затем реплицируются на резервные серверы.
        Реплицированные серверы могут временно содержать устаревшие данные.

        Преимущество: Быстрое время записи на основной сервер.

        Недостаток: Возможность незначительных расхождений в данных между основным и резервными серверами.


    Мастер-мастер (активная-активная) репликация:
        Все сервера базы данных могут одновременно принимать записи и реплицировать изменения друг другу.
        Используется в системах, требующих высокой доступности и отказоустойчивости.

        Преимущество: Повышенная доступность и балансировка нагрузки.

        Недостаток: Возможность конфликтов данных, которые необходимо решать.


    Мастер-слейв (активная-пассивная) репликация:
        Один сервер является основным (мастер), на который производятся записи, и один или несколько серверов
        являются резервными (слейв), которые только читают данные.

        Преимущество: Простота настройки и управления.

        Недостаток: Резервные серверы могут содержать устаревшие данные.


Преимущества репликации

    Высокая доступность:
        Если основной сервер выходит из строя, резервные сервера могут продолжить
        обслуживание запросов, обеспечивая доступность данных.


    Балансировка нагрузки:
        Запросы на чтение могут распределяться между несколькими серверами,
        что снижает нагрузку на основной сервер и улучшает производительность.


    Отказоустойчивость:
        В случае сбоя основного сервера система может автоматически переключиться
        на резервный сервер, минимизируя время простоя.


    Географическое распределение:
        Репликация позволяет разместить копии данных ближе к пользователям, что уменьшает задержки при доступе к данным.


Недостатки репликации

    Конфликты данных:
        В системах с мастер-мастер репликацией возможны конфликты данных, которые необходимо разрешать.


    Сложность управления:
        Управление реплицированными системами может быть сложным, особенно при наличии множества серверов.


    Расходы на хранение и ресурсы:
        Репликация требует дополнительных серверов и ресурсов для хранения и управления копиями данных.
        


Настройка мастера и слейва в PostgreSQL
    
    1. Настройка мастера

    Измените файл конфигурации postgresql.conf на мастер-сервере:
        
        Найдите и измените следующие параметры:
    
            listen_addresses = '*'
            wal_level = replica
            max_wal_senders = 10
            wal_keep_size = 64
            archive_mode = on
            archive_command = 'cp %p /var/lib/postgresql/12/main/archive/%f'


    Перезапустите PostgreSQL сервер:
    
        sudo service postgresql restart

    
    Настройте аутентификацию репликации в pg_hba.conf:

        Добавьте следующую строку для разрешения подключения репликации от слейв-сервера:

            host    replication     replica     <slave_ip>/32    md5

    
    Создайте пользователя для репликации:
     
        CREATE ROLE replica WITH REPLICATION PASSWORD 'password' LOGIN;
    

    Создайте базу данных:
    
        Если базы данных еще нет, создайте ее:
    
            sudo -u postgres createdb mydatabase
    
    
    2. Настройка слейва
    
        Подготовьте слейв-сервер:
    
            Остановите PostgreSQL на слейв-сервере:
    
                sudo service postgresql stop
        
    
        Скопируйте данные с мастер-сервера:
        
            Используйте утилиту pg_basebackup для создания базы данных слейв-сервера:
            
                pg_basebackup -h <master_ip> -D /var/lib/postgresql/12/main -U replica -W -P --wal-method=stream
        
            Создайте файл recovery.conf в директории данных слейв-сервера:
        
                Создайте файл и добавьте в него следующие строки:
                    
                    standby_mode = 'on'
                    primary_conninfo = 'host=<master_ip> port=5432 user=replica password=password'
                    trigger_file = '/tmp/postgresql.trigger.5432'
                
        
                В PostgreSQL 12 и выше, файл recovery.conf заменен на использование параметра конфигурации postgresql.conf:
        
                    primary_conninfo = 'host=<master_ip> port=5432 user=replica password=password'
                    recovery_target_timeline = 'latest'
        
    
            Запустите слейв-сервер: 
    
                sudo service postgresql start
    
    
    3. Проверка статуса репликации
    
        На мастер-сервере:
    
            Используйте следующую команду, чтобы проверить статус подключений репликации:
            
                SELECT * FROM pg_stat_replication;
    
    
        На слейв-сервере:
    
            Используйте следующую команду, чтобы проверить статус репликации:
                
                SELECT * FROM pg_stat_wal_receiver;


Заключение

    Репликация баз данных — это важная технология для обеспечения высокой доступности, 
    отказоустойчивости и производительности систем. Она позволяет распределять нагрузку, 
    снижать риски сбоев и улучшать общую масштабируемость системы. Однако настройка и управление репликацией 
    требуют тщательного планирования и мониторинга для обеспечения целостности данных и корректной работы системы.